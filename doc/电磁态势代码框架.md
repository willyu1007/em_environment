# 鐢电鎬佸娍浼扮畻鏈嶅姟 鈥斺€?浠ｇ爜妗嗘灦鏂囨。
> 闈㈠悜浠ｇ爜鐢熸垚妯″瀷锛堝 OpenAI Codex銆丟PT-4/5 浠ｇ爜鍔╂墜锛夌洿鎺ヤ骇鍑轰唬鐮侀鏋朵笌鍏抽敭瀹炵幇銆? 
> 璇█寤鸿锛?*Python 3.10+**锛堟暟鍊艰绠椾笌鏈嶅姟绔疄鐜版垚鐔熴€佺敓鎬佷赴瀵岋級銆?
---

## 0. 璁惧畾
- 鍗曢珮搴﹀垏鐗囷紙AMSL锛屽崟浣?m锛夈€?- 缃戞牸鍒嗚鲸鐜囷細榛樿 **0.01掳**銆?- 浼犳挱锛氶粯璁?**Free Space**锛涘彲閫?**Two-Ray Flat**锛堝紑鍏筹紝榛樿鍏抽棴锛夈€?- 澶ф皵/闆ㄩ浘锛氳繎浼奸檮鍔犳崯鑰楋紙鍙叧锛岄粯璁ゅ紑锛屽弬鏁拌鍓嶇疆瑙勮寖锛夈€?- 鏈夋晥鍦扮悆鍗婂緞锛?*k = 4/3**锛堝浐瀹氾級銆?- 澶╃嚎锛欻PBW 楂樻柉涓荤摚 + **鍓摚妯℃澘**锛? 绉嶏紝榛樿 `MIL-STD-20`锛夈€?- 鎵弿鏃堕棿鑱氬悎锛?*peak**锛堜富鐡ｆ壂杩囬偅涓€鍒荤殑宄板€硷級銆?- 棰戞锛歏HF/UHF/L/S/C/X/Ku/Ka锛岀粺涓€鍙傝€冨甫瀹?**1 MHz**锛?*Ka 娈典笉鍋?3 鐐归噰鏍?*銆?- 鍙犲姞锛氬姛鐜囧瘑搴﹀煙姹傚拰锛坧ower_sum锛夈€?- 闃堝€艰鍓細**40 dB渭V/m** 浠ヤ笅鍙鍓负 no-data锛堝彲閰嶇疆锛夈€?- Top-k 璐＄尞锛?*k=3 鍥哄畾**锛堢敤浜庤瘖鏂緭鍑猴級銆?- 瑙勬ā锛氭渶澶ф簮鏁?50锛涘尯鍩熷昂瀵哥害 200脳200 km锛涜緭鍑轰笉鑰冭檻閬斀/缁曞皠銆?
---

## 1. 宸ョ▼缁撴瀯
```text
emenv/
  鈹溾攢 emenv/                          # 绠楁硶鍜岃绠?  鈹?  鈹溾攢 __init__.py
  鈹?  鈹溾攢 config.py                   # 閰嶇疆妯″瀷涓庨粯璁ゅ€?  鈹?  鈹溾攢 geo.py                      # 鍦扮悊/娴嬪湴宸ュ叿锛堢悆闈㈣窛绂汇€佹柟浣嶏級
  鈹?  鈹溾攢 grid.py                     # 缃戞牸鐢熸垚銆佺摝鐗囧垏鍒嗐€佺储寮?  鈹?  鈹溾攢 antenna.py                  # 澶╃嚎澧炵泭妯″瀷銆佹ā鏉裤€佹壂鎻忓嘲鍊奸€昏緫
  鈹?  鈹溾攢 propagation.py              # FSPL銆乀wo-Ray-Flat銆佸ぇ姘?闆ㄩ浘鎹熻€?  鈹?  鈹溾攢 combine.py                  # 婧愯础鐚彔鍔犮€乀op-k 缁熻
  鈹?  鈹溾攢 bands.py                    # 棰戞/鍙傝€冨甫瀹藉鐞?  鈹?  鈹溾攢 engine.py                   # 涓昏绠楀紩鎿庯紙鍒嗗潡銆佸悜閲忓寲銆佺紦瀛橈級
  鈹?  鈹溾攢 io_raster.py                # GeoTIFF/NetCDF 鍐欏嚭锛堝彲閫?Parquet锛?  鈹?  鈹溾攢 api_models.py               # Pydantic I/O 鏁版嵁妯″瀷锛圧EST/CLI 鍏辩敤锛?  鈹?  鈹溾攢 service.py                  # 鏌ヨ鎺ュ彛锛氱粡绾害鈫掑€硷紝鎸夋簮鍒嗚В
  鈹?  鈹斺攢 utils.py                    # 鍗曚綅鎹㈢畻銆佹暟鍊肩ǔ瀹氥€丩UT 缂撳瓨
  鈹?  鈹溾攢 app/
  鈹?  鈹溾攢 __init__.py
  鈹?  鈹溾攢 rest.py                     # FastAPI锛?compute, /query, /health
  鈹?  鈹斺攢 cli.py                      # 鍛戒护琛岋細绂荤嚎鎵瑰鐞?鐢熸垚鐡︾墖
  鈹?  鈹溾攢 tests/                          # 鍗曞厓/闆嗘垚娴嬭瘯
  鈹?  鈹溾攢 test_geo.py
  鈹?  鈹溾攢 test_antenna.py
  鈹?  鈹溾攢 test_propagation.py
  鈹?  鈹溾攢 test_engine.py
  鈹?  鈹斺攢 data/fixtures.json
  鈹?  鈹溾攢 examples/
  鈹?  鈹溾攢 input_spec.json             # 绀轰緥杈撳叆锛堝彲鐩存帴杩愯锛?  鈹?  鈹斺攢 run_local.md                # 鏈湴杩愯鎸囧崡
  鈹?  鈹溾攢 pyproject.toml                  # 渚濊禆锛坧ydantic, numpy, numba, rasterio, xarray, fastapi, uvicorn锛?  鈹斺攢 README.md
```

---

## 2. 渚濊禆
- **numpy**锛堝悜閲忓寲锛夈€?*numba**锛堝彲閫?JIT 鍔犻€燂級銆?*pydantic**锛堟暟鎹ā鍨嬶級銆?*fastapi/uvicorn**锛圧EST锛夈€?- **rasterio**锛圙eoTIFF锛夈€?*xarray/netCDF4**锛圢etCDF锛夈€?*pyproj** 鎴栬嚜鍐欐祴鍦拌绠楋紙鏈鏋跺唴缃悆闈㈡祴鍦帮級銆?- 鍙€夛細**h3**锛堢┖闂寸储寮曪紝鑻ヤ笉寮曞叆锛屼娇鐢ㄨ嚜鍐?R 鏍戞垨绠€鍗曠悆闈㈢獥鍙ｇ瓫閫夛級銆?
---

## 3. 鏁版嵁妯″瀷
```python
# emenv/api_models.py
from pydantic import BaseModel, Field
from typing import List, Literal, Optional

class LatLon(BaseModel):
    lat: float
    lon: float

class Region(BaseModel):
    crs: Literal["WGS84"] = "WGS84"
    polygon: List[LatLon]  # 椤烘椂閽堬紝>=3

class GridSpec(BaseModel):
    resolution_deg: float = 0.01
    alt_m: float  # 鍗曢珮搴﹀垏鐗囷紙AMSL锛?
class Atmosphere(BaseModel):
    gas_loss: float | Literal["auto"] = "auto"
    rain_rate_mmph: float = 0.0
    fog_lwc_gm3: float = 0.0

class Propagation(BaseModel):
    model: Literal["free_space", "two_ray_flat"] = "free_space"

class Earth(BaseModel):
    k_factor: float = 4/3  # 鍥哄畾

class Environment(BaseModel):
    propagation: Propagation = Propagation()
    atmosphere: Atmosphere = Atmosphere()
    earth: Earth = Earth()

class AntennaPattern(BaseModel):
    type: Literal["simplified_directional"] = "simplified_directional"
    hpbw_deg: float
    vpbw_deg: float
    sidelobe_template: Literal["MIL-STD-20", "RCS-13", "Radar-Narrow-25", "Comm-Omni-Back-10"] = "MIL-STD-20"

class ScanSpec(BaseModel):
    mode: Literal["none", "circular", "sector"] = "none"
    rpm: float = 0.0
    sector_deg: float = 0.0  # circular鏃?360

class Antenna(BaseModel):
    pattern: AntennaPattern
    pointing_az_deg: float = 0.0
    pointing_el_deg: float = 0.0
    scan: ScanSpec = ScanSpec()

class Emission(BaseModel):
    eirp_dBm: float
    center_freq_MHz: float
    bandwidth_MHz: float
    polarization: Literal["H", "V", "RHCP", "LHCP"] = "H"
    duty_cycle: float = 1.0  # peak鑱氬悎涓嬩笉鍚敤骞冲潎

class Source(BaseModel):
    id: str
    type: Literal["radar", "comm", "jammer", "other"] = "radar"
    position: LatLon
    alt_m: float
    emission: Emission
    antenna: Antenna

class Band(BaseModel):
    name: str
    f_min_MHz: float
    f_max_MHz: float
    ref_bw_kHz: float = 1000.0

class Limits(BaseModel):
    max_sources: int = 50
    max_region_km: float = 200.0

class ComputeRequest(BaseModel):
    region: Region
    grid: GridSpec
    influence_buffer_km: float = 200.0
    environment: Environment = Environment()
    bands: List[Band]
    metric: Literal["E_field_dBuV_per_m"] = "E_field_dBuV_per_m"
    combine_sources: Literal["power_sum"] = "power_sum"
    temporal_agg: Literal["peak"] = "peak"
    limits: Limits = Limits()
    sources: List[Source]
    threshold_dbuv_per_m: float = 40.0  # 闃堝€艰鍓?    topk_contrib: int = 3               # 鍥哄畾3锛屽彲鍦ㄦ牎楠屼腑寮哄埗涓?

class QueryRequest(BaseModel):
    lat: float
    lon: float
    alt_m: float
    band: str
```
> 璇存槑锛歚Source.position` 涓虹粡绾害锛宍alt_m` 鍗曠嫭瀛楁锛圓MSL锛夈€?
---

## 4. 浼唬鐮?
### 4.1 鐞冮潰娴嬪湴锛坓eo.py锛?```python
def haversine_km(lat1, lon1, lat2, lon2) -> float: ...
def fwd_azimuth_deg(lat1, lon1, lat2, lon2) -> float: ...
# k=4/3 鍦?two-ray 鍑犱綍/浠拌浼扮畻鏃朵娇鐢?```

### 4.2 澶╃嚎澧炵泭锛坅ntenna.py锛?**鍓摚妯℃澘**
```python
SL_TEMPLATES = {
  "MIL-STD-20": lambda off_axis_deg: -20.0,
  "RCS-13":     lambda off_axis_deg: -13.0 if off_axis_deg < 10 else -20.0,
  "Radar-Narrow-25": lambda off_axis_deg: -20.0 if off_axis_deg < 10 else -25.0,
  "Comm-Omni-Back-10": lambda off_axis_deg: -10.0
}
```

**涓荤摚楂樻柉杩戜技**锛?```python
def mainlobe_gain_dBi(delta_az_deg, delta_el_deg, hpbw_deg, vpbw_deg, g_peak_dBi=0.0):
    k = 4.0 * np.log(2.0)
    gh = g_peak_dBi - 10.0 * np.log10(np.e) * k * (delta_az_deg / hpbw_deg)**2
    gv = g_peak_dBi - 10.0 * np.log10(np.e) * k * (delta_el_deg / vpbw_deg)**2
    return min(gh, gv)
```

**鎵弿宄板€奸€昏緫**锛?```python
def peak_gain_dBi(point_bearing_deg, point_elev_deg, antenna: Antenna):
    if in_scan_coverage(point_bearing_deg, antenna.scan):
        return 0.0  # 杩戜技涓荤摚宄板€?    off_az = angular_diff_deg(point_bearing_deg, antenna.pointing_az_deg)
    off_el = point_elev_deg - antenna.pointing_el_deg
    g_mb = mainlobe_gain_dBi(off_az, off_el, antenna.pattern.hpbw_deg, antenna.pattern.vpbw_deg, 0.0)
    g_sl = SL_TEMPLATES[antenna.pattern.sidelobe_template](abs(off_az))
    return max(g_mb, g_sl)
```

### 4.3 浼犳挱锛坧ropagation.py锛?```python
def fspl_dB(f_MHz, r_km):
    return 32.45 + 20*np.log10(f_MHz) + 20*np.log10(np.maximum(r_km, 1e-6))
# two_ray_flat: 鐩村皠+鍙嶅皠锛岃繎鍦轰笅闄?r_min=10*lambda锛岀浉浣嶅钩婊戯紱H/V 鍙嶅皠绯绘暟杩戜技
```

### 4.4 澶ф皵/闆ㄩ浘锛堥檮鍔犳崯鑰?dB锛?```python
def atmos_loss_dB_per_km(f_MHz, rain_rate_mmph, fog_lwc_gm3, gas="auto") -> float: ...
def total_extra_loss_dB(f_MHz, r_km, env): return atmos_loss_dB_per_km(...) * r_km
```

### 4.5 EIRP鈫掔數鍦?& 鍙犲姞锛坈ombine.py锛?```python
Z0 = 377.0
def eirp_dBm_to_W(eirp_dBm): return 10**((eirp_dBm-30)/10)
def power_density_W_m2(eirp_W, gain_lin, r_m, extra_loss_dB):
    return (eirp_W * gain_lin) / (4*np.pi*r_m**2) * 10**(-extra_loss_dB/10)
def field_strength_dBuV_per_m(S_W_m2):
    E_V_m = np.sqrt(Z0 * S_W_m2); return 20*np.log10(np.maximum(E_V_m, 1e-15)) + 120.0
def sum_sources_and_topk(S_list):
    S_tot = np.sum(S_list, axis=0); idx = np.argsort(S_list, axis=0)[-3:][::-1]; return S_tot, idx
```

---

## 5. 涓昏绠楀紩鎿庯紙engine.py锛変吉浠ｇ爜
```python
def compute_tiles(req: ComputeRequest):
    # 1) 棰勫鐞?    tiles = build_tiles(req.region, req.grid.resolution_deg)
    srcs = filter_sources_by_buffer(req.sources, req.region, req.influence_buffer_km)
    bands = center_freqs(req.bands)  # 鍙栦腑蹇冮鐜?
    # 2) 閬嶅巻鐡︾墖
    for tile in tiles:
        latlon = tile.latlon_mesh()  # (H,W,2)
        geom = geom_from_sources(srcs, latlon, req.grid.alt_m, k_factor=4/3)  # r_km, bearing, elev

        for band in bands:
            f = band.center_MHz
            gains_dBi = antenna_peak_or_offaxis(srcs, geom.bearing_deg, geom.elev_deg)  # (Nsrc,H,W)
            fspl = fspl_dB(f, geom.r_km)                                               # (Nsrc,H,W)
            extra = total_extra_loss_dB(f, geom.r_km, req.environment)

            eirp_W = eirp_vector(srcs)[:,None,None]
            S = power_density_W_m2(eirp_W, 10**(gains_dBi/10), geom.r_km*1000, fspl+extra)

            S_tot, topk_idx = sum_sources_and_topk(S)
            E = field_strength_dBuV_per_m(S_tot)
            E[E < req.threshold_dbuv_per_m] = float("nan")

            write_raster(tile, band.name, E, meta=req)
            write_topk(tile, band.name, topk_idx, S, srcs)
```

---

## 6. REST 涓?CLI锛坅pp/锛?瑙侀鏋讹細`/compute`锛堟彁浜よ绠楋級涓?`/query`锛堣繑鍥炲€间笌 top-3锛夈€侰LI 鏀寔鎵瑰鐞嗕笌鏈湴娴嬭瘯銆?
---

## 7. 杈撳嚭涓庣储寮?- 鏍呮牸锛欸eoTIFF锛宍nodata=NaN`锛屽€?`E_field_dB渭V/m`锛涙瘡 band/鐡︾墖涓€鏂囦欢銆?- 绱㈠紩锛歚index.json` 璁板綍鐡︾墖鑼冨洿銆乥and銆佸弬鏁板搱甯屻€佹簮娓呭崟蹇収銆?- Top-3锛歚.jsonl` 鎴?`.parquet`锛屾寜鍍忕礌璁板綍 top-3 婧?id 涓庤础鐚崰姣斻€?
---

## 8. 娴嬭瘯涓庨獙鏀?- 瑕嗙洊 geo/antenna/propagation/engine 鍏抽敭璺緞锛?- 灏忓尯鍩熶笌鎵嬬畻鍩哄噯姣斿锛?- Two-Ray 鍙厛璺宠繃锛岀暀鍚庣画浠诲姟銆?
---

## 9. 浠ｇ爜鐢熸垚妯″瀷娉ㄦ剰
- 涓ユ牸鎸夋枃浠跺悕涓庡嚱鏁板悕鍒涘缓妯″潡锛?- 鍏堝疄鐜?FSPL 娴佺▼锛孴wo-Ray 鐣?TODO锛?- 蹇呴』鍖呭惈闃堝€艰鍓紙40 dB渭V/m锛変笌 **Top-3 鍥哄畾**锛?- 浣跨敤 NumPy 鍚戦噺鍖栦笌鍒嗗潡鍐欏嚭锛岄伩鍏嶄竴娆℃€у崰婊″唴瀛樸€?
鈥斺€?瀹?鈥斺€?
