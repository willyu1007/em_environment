# 电磁态势估算服务 —— 代码框架与模块说明（v1）

> 面向代码协作与实现的框架性说明，概述目录结构、核心模块职责、数据约定与落盘能力。

---

## 0. 约定
- 单一高度切片（AMSL，单位 m）
- 网格角分辨率：默认 0.01°
- 传播：默认 Free Space，可选 Two‑Ray Flat（关闭为默认）
- 大气/降雨/雾衰：近似可开关，参数见输入规范
- 有效地球曲率：k = 4/3（固定）
- 天线：HPBW 高斯主瓣 + 副瓣模板（默认 MIL‑STD‑20）
- 扫描聚合：peak（主瓣扫过取峰值）
- 频段：VHF/UHF/L/S/C/X/Ku/Ka，统一参考带宽 1 MHz
- 多源合并：power_sum（线性功率相加）
- 阈值裁剪：40 dBµV/m 以下置为 NoData（可配置）
- Top‑K：固定 3（用于诊断/可视化）
- 规模建议：≤ 50 源、区域≤约 200×200 km；不考虑遮蔽/绕射

---

## 1. 目录结构（摘要）
```text
emenv/
  ├─ config.py            # 引擎/阈值/Top‑K 等配置
  ├─ geo.py               # 球面距离、方位角、仰角等几何工具
  ├─ grid.py              # 网格生成与掩膜
  ├─ antenna.py           # 天线主瓣/副瓣与扫描峰值增益
  ├─ propagation.py       # FSPL / Two‑Ray / 大气附加损耗
  ├─ combine.py           # EIRP→功率密度、场强换算、合并与 Top‑K
  ├─ bands.py             # 频段中心频率等工具
  ├─ engine.py            # 主计算流程（单高度切片）
  ├─ io_raster.py         # GeoTIFF 与 Top‑K Parquet 写出
  ├─ api_models.py        # Pydantic 输入/输出模型（REST/CLI 共用）
  ├─ service.py           # 计算编排、缓存、点查询/写出
  └─ app/
     ├─ rest.py           # FastAPI：/compute /query /health
     ├─ cli.py            # 命令行：读取请求、执行计算、可选写文件
     ├─ visualizer.py     # Streamlit 可视化（读取 GeoTIFF/Parquet）
     └─ visualizer_launcher.py
```

---

## 2. 关键数据模型（见 `emenv/api_models.py`）
- `Region`：WGS‑84 多边形（度）
- `GridSpec`：`resolution_deg`、`alt_m`
- `Environment`：`Propagation{model}`、`Atmosphere{gas_loss, rain, fog}`、`Earth{k_factor}`
- `Antenna{pattern, pointing_az_deg, pointing_el_deg, scan}`（支持 `pointing{az_deg, el_deg}` 输入映射）
- `Emission{eirp_dBm, center_freq_MHz, bandwidth_MHz, polarization, duty_cycle}`
- `Source{id, type, position{lat,lon,alt_m}, emission, antenna}`
- `Band{name, f_min_MHz, f_max_MHz, ref_bw_kHz}`
- `ComputeRequest{region, grid, influence_buffer_km, environment, bands, metric, combine_sources, temporal_agg, limits, sources}`

约束要点：
- `bands`: `f_max_MHz > f_min_MHz`，`ref_bw_kHz > 0`（默认 1000）
- `limits`: `max_sources ≤ 50`、`max_region_km ≈ 200`（默认），防止超大任务

---

## 3. 计算流程（`engine.ComputeEngine.compute`）
1) 生成经纬网格与掩膜（`grid.create_grid`）
2) 依据区域中心与缓冲半径过滤源（`_filter_sources`）
3) 预计算几何关系（水平/斜距、方位、仰角；`_prepare_geometry`）
4) 对每个频段中心频率：
   - 天线方向性增益（扫描取峰值；`antenna.peak_gain_dBi`）
   - 传播附加损耗（FSPL 之外；`propagation_additional_loss_dB`）
   - EIRP→功率密度 S（W/m²），合并得到总 S 与 Top‑K 索引（`combine`）
   - 场强 E（dBµV/m）换算与阈值裁剪；区域外置 NaN
   - 组装 `BandResult`（包含 `field_strength_dbuv_per_m`、`power_density_W_m2`、`topk_indices`、`topk_fraction`）
5) 产出 `ComputeResult`，可调用 `write_outputs(output_dir)` 写出文件

---

## 4. 写出（`io_raster.py`）
- GeoTIFF：WGS‑84、Float32、`nodata=NaN`，文件名 `{Band}_field_strength.tif`，值为 `E_field_dBµV/m`
- Parquet：Top‑K 诊断 `{Band}_topk.parquet`，列：`lat, lon, band, rank, source_index, source_id, fraction, power_W_m2`

---

## 5. 服务与工具
- REST（`app/rest.py`）：`/compute` 提交计算，`/query` 点查询（需匹配高度与频段）
- CLI（`app/cli.py`）：`python -m emenv.app.cli examples/input_spec.json --output-dir outputs/latest`
- 可视化（`app/visualizer.py`）：`streamlit run emenv/app/visualizer.py`

---

## 6. 测试与验收
- 单元/集成：`tests/` 覆盖 `geo/antenna/propagation/engine`
- 基准核对：小区域手算/已知场景对比
- Two‑Ray：先保证 FSPL 主线，逐步增强反射模型

---

## 7. 注意事项
- 固定 `k=4/3`；若要暴露需同步配置与文档
- 阈值与 Top‑K 在 `config.EngineConfig` 可覆盖
- 大区域/多源建议分块与并行；必要时增加流式写出

—— 完 ——
