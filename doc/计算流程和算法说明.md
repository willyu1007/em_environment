# 电磁环境态势估算算法说明（实现对照）

本文档基于当前代码实现（`emenv/` 目录）整理端到端流程，并对核心函数、关键算法与所采用的公式进行说明，供研发、测试与服务化部署参考。实现遵循《EM_env_service_spec.md》：暂不考虑遮蔽/绕射，只模拟几何扩散、天线方向性与可选的附加传播衰减。

---

## 1. 数据接口概览

### 1.1 输入：`ComputeRequest`

| 模块 | 关键字段 | 说明 |
| --- | --- | --- |
| 区域 | `region.polygon` | 兴趣区多边形（WGS‑84，经纬度，至少 3 个顶点） |
| 网格 | `grid.resolution_deg`<br>`grid.alt_m` | 角分辨率（degree）与接收高度（m AMSL） |
| 源过滤 | `influence_buffer_km` | 区域外扩半径，以剔除远距离源 |
| 环境 | `environment.propagation.model`<br>`environment.atmosphere.*`<br>`environment.earth.k_factor` | 传播模型（`free_space` / `two_ray_flat`）、气体/雨/雾衰减参数（dB/km）与有效地球半径系数 |
| 频段 | `bands[]` | 每个频段提供 `f_min_MHz`、`f_max_MHz`、`ref_bw_kHz` |
| 源 | `sources[]` | 位置 (`lat/lon/alt`)、发射 (`eirp_dBm`、`center_freq_MHz`、`bandwidth`) 与天线 (`pattern`、`scan`、`pointing`) |
| 其他 | `metric`、`combine_sources`、`temporal_agg`、`limits` | 输出类型、功率合并方式、时间聚合策略、任务上限 |

### 1.2 输出：`ComputeResult`

每个频段生成一个 `BandResult`：

- `field_strength_dbuv_per_m`：栅格化电场强度（dBµV/m）
- `power_density_W_m2`：栅格化功率密度（W/m²）
- `topk_indices`、`topk_power_W_m2`、`topk_fraction`：Top‑K 贡献源诊断
- 元数据：中心频率、源 ID 列表等

辅助方法 `write_outputs(output_dir)` 会生成：

- GeoTIFF (`*_field_strength.tif`)：电场强度栅格，坐标系 EPSG:4326
- Parquet (`*_topk.parquet`)：按像元展开的 Top‑K 贡献记录

---

## 2. 端到端计算流程（`emenv.engine.ComputeEngine`）

1. **构建采样网格 – `grid.create_grid(region, resolution_deg, alt_m)`**
   - `_polygon_arrays` 解析多边形。
   - `np.arange` + `np.meshgrid` 生成经纬度网格。
   - `_point_in_polygon`（矢量化 Ray Casting）给出布尔掩膜。
   - 返回 `GridDefinition`，包含 `latitudes`、`longitudes`、`mask`、`resolution_deg`、`alt_m`。

2. **源过滤 – `_filter_sources`**
   - 计算兴趣区（或掩膜有效像元）的球面范围 `extent_km = max(haversine_km(...))`。
   - 以区域中心为圆心，半径 `extent_km + influence_buffer_km` 粗过滤源集合。
   - 减少后续计算中的无效源。

3. **几何量预计算 – `_prepare_geometry`**
   - 对每个源广播生成网格维度的张量：
     - 水平距离：`horizontal_km = haversine_km(src_lat, src_lon, lat_mesh, lon_mesh)`
     - 高度差：`delta_alt_m = rx_alt - src_alt`
     - 斜距：`slant_km = sqrt(horizontal_km**2 + (delta_alt_m / 1000)**2)`
     - 方位角：`bearing_deg = forward_azimuth_deg(...)`
     - 仰角：`elevation_deg = elevation_angle_deg(horizontal_km, delta_alt_m)`
   - 这些张量直接供天线增益与传播模型使用。

4. **频段循环与功率叠加**
   - 频段中心频率由 `bands_center_array` 计算。
   - 传播附加损耗：
     ```python
     extra_loss_dB = propagation_additional_loss_dB(
         f_MHz=freq_array,
         slant_km=geom.slant_km,
         horizontal_km=geom.horizontal_km,
         tx_alt_m=geom.tx_alt_m,
         rx_alt_m=geom.rx_alt_m,
         environment=request.environment,
     )
     ```
   - 天线方向性（详见 §3.3）：`gain_lin = 10 ** (peak_gain_dBi(...) / 10)`。
   - 功率密度（公式见 §3.4）：`power_density_W_m2(eirp_W, gain_lin, r_m, extra_loss_dB)`。
   - 合并与诊断：`sum_sources_and_topk(power_density, top_k)` → 总功率密度与 Top‑K 索引。
   - 电场强度：`field_strength = field_strength_dBuV_per_m(total_power_density)`。
   - 应用掩膜与阈值：`field_strength[~grid.mask] = np.nan`；若启用阈值，则将低于阈值的像元置 `NaN`。

5. **结果封装**
   - 构造 `BandResult`，写入 `ComputeResult.band_results`。
   - 可通过 `ComputeService` 缓存最近结果，支持 REST 查询或 CLI 输出。

---

## 3. 核心模块与公式

### 3.1 `grid.py` – 网格生成

| 函数 | 逻辑要点 | 输出 |
| --- | --- | --- |
| `_polygon_arrays(polygon)` | 兼容对象/字典两种顶点格式，返回浮点数组 | `(latitudes, longitudes)` |
| `_point_in_polygon(lats, lons, poly_lats, poly_lons)` | 射线法判定点集是否位于多边形内部，支持矢量化 | 布尔掩膜 |
| `build_grid(region, resolution_deg)` | 构造规则网格，应用掩膜 | `(lat_mesh, lon_mesh, mask)` |
| `create_grid(region, resolution_deg, alt_m)` | 将网格信息封装为 `GridDefinition` dataclass | `GridDefinition` |

### 3.2 `geo.py` – 地理几何

- **哈弗辛距离**  
  \[
  \begin{aligned}
  a &= \sin^2\left(\frac{\Delta\phi}{2}\right) + \cos\phi_1 \cos\phi_2 \sin^2\left(\frac{\Delta\lambda}{2}\right) \\
  d &= 2 R \arctan2(\sqrt{a}, \sqrt{1-a})
  \end{aligned}
  \]
  函数：`haversine_km(lat1, lon1, lat2, lon2, radius_km)`，默认地球半径 6371 km，可由 `k_factor` 放大。

- **前向方位角**  
  \[
  \theta = \operatorname{atan2}\left(\sin\Delta\lambda \cos\phi_2,\; \cos\phi_1 \sin\phi_2 - \sin\phi_1 \cos\phi_2 \cos\Delta\lambda \right)
  \]
  函数：`forward_azimuth_deg(...)`，输出范围 `[0°, 360°)`。

- **仰角**  
  \[
  \alpha = \arctan2(\Delta h,\; d_h),\quad d_h = \max(\text{horizontal}_\text{km}, 10^{-6}) \times 1000
  \]
  函数：`elevation_angle_deg(horizontal_km, delta_alt_m)`。

### 3.3 `antenna.py` – 天线方向性模型

1. **主瓣高斯近似** (`mainlobe_gain_dBi`)  
   \[
   G_\text{mb}(\Delta\phi,\Delta\theta) = G_\text{peak} - \frac{4 \ln 2}{\ln 10} \cdot 10 \left[\left(\frac{\Delta\phi}{\text{HPBW}_h}\right)^2 + \left(\frac{\Delta\theta}{\text{HPBW}_v}\right)^2\right]
   \]
   - HPBW：水平/垂直半功率角（度）。
   - 近似假设主瓣为可分离的二维高斯。

2. **扫描覆盖** (`in_scan_coverage`)
   - `none`：固定指向，仅主瓣方向有效。
   - `circular`：恒定覆盖 360°。
   - `sector`：判断方位差是否在扇区半宽 `sector_deg/2` 内。

3. **副瓣模板** (`SL_TEMPLATES`)
   - 如 `"MIL-STD-20"`：全向定值 −20 dBi。
   - `"RCS-13"`：主瓣 ±10° 内 −13 dBi，外 −20 dBi 等。

4. **综合增益** (`peak_gain_dBi`)
   - 计算扫描覆盖、主瓣增益与副瓣模板。
   - 逻辑：若方向在覆盖内取 `max(mainlobe, sidelobe)`，否则回退到副瓣电平；确保扫描外仍保留最低辐射。

### 3.4 `combine.py` – 功率与电场换算

1. **EIRP 单位换算**  
   \[
   \text{EIRP}_\text{W} = 10^{(\text{EIRP}_\text{dBm} - 30) / 10}
   \]
   函数：`eirp_dBm_to_W(eirp_dBm)`。

2. **功率密度** (`power_density_W_m2`)
   \[
   S = \frac{\text{EIRP}_\text{W} \cdot G_\text{lin}}{4\pi r^2} \cdot 10^{-L_\text{add}/10}
   \]
   - `G_lin = 10^{G_\text{dBi}/10}`。
   - `r = slant_km × 1000`。
   - `L_add` 为附加损耗（dB）。

3. **电场强度** (`field_strength_dBuV_per_m`)
   \[
   E_\text{dBµV/m} = 20 \log_{10}\left(\sqrt{Z_0 S}\right) + 120,\qquad Z_0 = 377\,\Omega
   \]

4. **功率叠加与 Top‑K** (`sum_sources_and_topk`)
   - 轴向相加得到总功率密度。
   - 使用 `np.argsort` 获取 Top‑K 源索引。
   - 返回 `(total_power_density, top_indices)`，并在上层算出占比。

### 3.5 `propagation.py` – 传播附加损耗

1. **自由空间路径损耗** (`fspl_dB`)
   \[
   L_\text{FSPL} = 32.45 + 20 \log_{10}(f_\text{MHz}) + 20 \log_{10}(r_\text{km})
   \]

2. **平坦两射线模型** (`two_ray_flat_loss_dB`)
   - 水平距离 `d_h` → 米；波长 λ = c / (f·10⁶)。
   - 直接/反射路径长度差 → 相位差  
     \[
     \Delta\phi = \frac{2\pi}{\lambda}(d_\text{refl} - d_\text{dir})
     \]
   - 反射系数（水平极化）假设 `Γ = -1`。
   - 干涉增益：\(|1 + Γ e^{-j\Delta\phi}|\)。
   - 总损耗：`FSPL(direct)` 减去干涉增益（以 dB 表达）。
   - 当 `d_h < 10 λ` 时回退到 FSPL。

3. **大气/雨/雾衰减** (`atmospheric_loss_dB_per_km`)
   ```text
   freq_GHz = max(f_MHz, 1e-6) / 1000
   gas_loss = gas_base * (1 + 0.1 * freq_GHz**1.2)
   rain_loss = 1e-4 * rain_rate_mmph * freq_GHz**0.8
   fog_loss  = 2e-4 * fog_lwc_gm3 * freq_GHz**2
   ```
   - `gas_base = 0.001`（auto 模式下），也可由请求显式给出数值。

4. **总附加损耗** (`propagation_additional_loss_dB`)
   \[
   L_\text{extra} =
   \begin{cases}
   L_\text{2‑ray} - L_\text{FSPL} + L_\text{atm} \cdot r_\text{km}, & \text{model} = \texttt{two\_ray\_flat} \\
   L_\text{atm} \cdot r_\text{km}, & \text{model} = \texttt{free\_space}
   \end{cases}
   \]

---

## 4. 辅助与服务层模块

| 模块 | 功能要点 |
| --- | --- |
| `config.py` | 默认参数（网格分辨率、影响缓冲、阈值、Top‑K、折射系数等）。 |
| `service.py` | `ComputeService` 聚合引擎执行、结果缓存、最近一次计算的点查询（最近邻方式）。 |
| `io_raster.py` | `_grid_resolution` 推导经纬度步长；`write_geotiff` 输出 WGS‑84 格式 GeoTIFF；`write_topk_parquet` 生成像元级 Top‑K 表。 |
| `app/cli.py` | 命令行入口：读取 JSON 请求、触发计算、输出统计并可写盘。 |
| `app/rest.py` | FastAPI 服务：`/compute` 触发一次计算，`/query` 在缓存结果上做点查询。 |
| `app/visualizer.py` | Streamlit 前端：加载 GeoTIFF/Parquet，展示热力图、统计信息、Top‑K 贡献与地图叠加。 |

---

## 5. 近似、限制与注意事项

1. **空间维度**：当前实现仅支持单高度切片（`grid.alt_m`），如需多高度需多次调用或扩展批处理。
2. **传播假设**：未建模地形、建筑遮挡与绕射，适用于视距/远场场景。
3. **时间聚合**：`temporal_agg="peak"` 代表取扫描峰值，尚未建模扫描占空比或旋转周期均值。
4. **数值稳定性**：当功率密度趋近 0 时，Top‑K 占比输出 `NaN` 或 0；传播公式中对分母做了 `max(..., ε)` 限制。
5. **性能限制**：任务规模受 `limits.max_sources` 以及网格分辨率、内存约束；如需大区域可分块或并行执行。

---

## 6. 默认参数与扩展建议

- 推荐默认值：
  - `grid.resolution_deg = 0.01`（约 1.1 km 地面间距）
  - `influence_buffer_km = 200`
  - `bands[].ref_bw_kHz = 1000`
  - `propagation.model = "free_space"`
  - `earth.k_factor = 4/3`
  - `combine_sources = "power_sum"`
  - `temporal_agg = "peak"`

- 可考虑的扩展方向：
  1. **传播模型**：在 `propagation.py` 接入 ITM、P.452、雨衰 ITU 曲线等更精细模型。
  2. **天线模式**：支持导入离散方向增益表或模式文件，替换现有高斯模板。
  3. **多高度/时间切片**：在 `ComputeEngine` 增加批处理接口，缓存几何量以提高复用率。
  4. **性能优化**：引入 numba/并行化或 GPU 加速应对大规模源与高分辨率栅格。

---

通过上述拆解，可快速定位各函数的职责、输入输出和背后的数学假设，方便开展算法验证、参数调优和服务化集成。***
