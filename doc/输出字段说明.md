# 电磁环境态势估算服务 —— 输出字段说明

> 本文档描述电磁环境态势估算服务的输出格式、数据结构和使用方式。

## 目录
- [输出概述](#输出概述)
- [目录结构](#目录结构)
- [栅格文件格式](#栅格文件格式)
- [诊断文件格式](#诊断文件格式)
- [数据指标与单位](#数据指标与单位)
- [使用示例](#使用示例)

---

## 输出概述

服务完成计算后，会产生以下两类输出：
1. **电场强度栅格**：GeoTIFF 格式，按频段分目录存储
2. **Top-K 贡献诊断**：Parquet 格式，记录主要辐射源对每个网格点的贡献

### 默认配置
- 坐标系：**WGS-84**（EPSG:4326）
- 高度：**AMSL**（海拔，米），单一切片
- 强度单位：**dBµV/m**（电场强度）
- 参考带宽：**1 MHz**（1000 kHz）
- 阈值：默认 40 dBµV/m
- Top-K：默认 Top-3（可在配置中修改）

---

## 目录结构

输出目录按以下结构组织：

```
output_dir/
├── VHF/
│   ├── VHF_field_strength.tif      # 电场强度栅格
│   └── VHF_topk.parquet            # Top-K 贡献诊断
├── UHF/
│   ├── UHF_field_strength.tif
│   └── UHF_topk.parquet
├── L/
│   ├── L_field_strength.tif
│   └── L_topk.parquet
├── S/
│   ├── S_field_strength.tif
│   └── S_topk.parquet
├── C/
│   ├── C_field_strength.tif
│   └── C_topk.parquet
├── X/
│   ├── X_field_strength.tif
│   └── X_topk.parquet
├── Ku/
│   ├── Ku_field_strength.tif
│   └── Ku_topk.parquet
└── Ka/
    ├── Ka_field_strength.tif
    └── Ka_topk.parquet
```

**说明**：
- 每个频段有独立的子目录
- 栅格文件名格式：`{频段名}_field_strength.tif`
- Top-K 文件名格式：`{频段名}_topk.parquet`

---

## 栅格文件格式

### GeoTIFF 技术规范

| 属性 | 值 |
|------|-----|
| 格式 | GeoTIFF (GTiff) |
| 坐标系 | WGS-84 (EPSG:4326) |
| 数据类型 | Float32 |
| 波段数 | 1 |
| NoData 值 | NaN（浮点空值） |
| 空间分辨率 | 由输入 `grid.resolution_deg` 决定（默认 0.01°） |
| 北向惯例 | 数据按行翻转（北向上） |

### 栅格内容

| 字段 | 单位 | 说明 |
|------|------|------|
| 像素值 | dBµV/m | 电场强度，折算到参考带宽（1 MHz） |
| 无效值 | NaN | 低于阈值或落在区域外的像素 |
| 有效范围 | ≥ 40 dBµV/m | 默认阈值之上的有效数据 |

### 读取示例

#### Python (rasterio)
```python
import rasterio
import numpy as np

# 读取栅格
with rasterio.open("output_dir/S/S_field_strength.tif") as src:
    data = src.read(1)  # 读取第一波段
    bounds = src.bounds
    crs = src.crs
    transform = src.transform
    nodata = src.nodata
    
    print(f"数据范围: {bounds}")
    print(f"形状: {data.shape}")
    print(f"坐标系: {crs}")
    print(f"有效数据统计: 最小值={np.nanmin(data):.2f}, 最大值={np.nanmax(data):.2f}")
    
    # 获取经纬度网格
    lats, lons = np.meshgrid(
        np.linspace(bounds.top, bounds.bottom, data.shape[0]),
        np.linspace(bounds.left, bounds.right, data.shape[1]),
        indexing='ij'
    )
```

#### QGIS/ArcGIS
1. 使用“添加栅格图层”加载 `.tif` 文件
2. 属性表将自动识别 WGS-84 坐标系
3. 可用于制图、叠加地形或与矢量数据叠加分析

---

## 诊断文件格式

### Parquet 技术规范

| 属性 | 值 |
|------|-----|
| 格式 | Apache Parquet |
| 压缩 | Snappy（默认） |
| 编码 | 列式存储 |
| 行数 | `有效像素数 × Top-K（默认3）` |

### 数据列定义

| 列名 | 类型 | 单位 | 说明 |
|------|------|------|------|
| `lat` | double | 度 | 网格点纬度（WGS-84） |
| `lon` | double | 度 | 网格点经度（WGS-84） |
| `band` | string | - | 频段名称（如 "S", "X"） |
| `rank` | int16 | - | 排名（0 = 最强，1 = 次强，...） |
| `source_index` | int32 | - | 源索引（与输入数组对应），-1 表示无效 |
| `source_id` | string | - | 源 ID（与输入的 `sources[].id` 对应） |
| `fraction` | float | - | 该源对总功率密度的贡献比例（0~1） |
| `power_W_m2` | float | W/m² | 该源在网格点的功率密度 |

### 数据行结构

每一行代表**一个网格点在某频段的 Top-K 贡献**：

```python
# 示例数据
lat       lon        band  rank  source_index  source_id      fraction  power_W_m2
33.80  118.00       S     0           0        radar_01      0.45      0.000397
33.80  118.00       S     1           2        jammer_02     0.32      0.000283
33.80  118.00       S     2           5        comm_03       0.23      0.000204
```

**说明**：
- `rank=0` 始终为最强贡献源
- `fraction` 总和可能小于 1（若存在其它源或不可忽略的背景）
- `source_index=-1` 且 `source_id` 为空时表示该网格点无有效信号

### 读取示例

#### Python (pandas/pyarrow)
```python
import pandas as pd
import pyarrow.parquet as pq

# 读取 Parquet
df = pd.read_parquet("output_dir/S/S_topk.parquet")

# 查询某坐标点
point_lat, point_lon = 33.80, 118.10
point_df = df[(df['lat'] == point_lat) & (df['lon'] == point_lon)]
print(f"主要贡献源: {point_df['source_id'].tolist()}")
print(f"贡献比例: {point_df['fraction'].tolist()}")

# 统计各源出现次数（Top-1）
top1_count = df[df['rank'] == 0].groupby('source_id').size()
print("\nTop-1 出现次数统计:")
print(top1_count)

# 导出为 CSV（可选）
df.to_csv("output_dir/S/S_topk.csv", index=False)
```

#### 分析示例（找出占主导地位的源）
```python
# 找出在超过 50% 的区域内占主导地位的源
top1 = df[df['rank'] == 0]
dominant_sources = top1[top1['fraction'] > 0.5].groupby('source_id').size()
print("占主导地位的源：", dominant_sources)
```

---

## 数据指标与单位

### 1. 电场强度（dBµV/m）

**定义**：电场强度，按参考带宽 1 MHz 折算。

**换算关系**：
```
E (dBµV/m) = 20·log₁₀(E_linear (µV/m))
```

**基准线**：
- 40 dBµV/m ≈ 100 µV/m
- 80 dBµV/m ≈ 10 mV/m
- 120 dBµV/m ≈ 1 V/m

**物理意义**：表示该点接收到的电磁辐射强度，用于评估对电子设备的干扰风险或通信/接收能力。

### 2. 功率密度（W/m²）

**定义**：单位面积上的功率流。

**换算关系**：
```
S (W/m²) = E² / (120π Ω⁻¹)
         ≈ E² / 377 (for free space)
```

**与电场强度的关系**：
```
S (W/m²) = 10^((E_dBuV_per_m - 145.76) / 10)
```

**典型值**：
- 10⁻¹² W/m² ≈ -120 dBm/m²（极弱）
- 10⁻⁶ W/m² ≈ -60 dBm/m²（微弱）
- 10⁻³ W/m² ≈ -30 dBm/m²（中强）

### 3. 贡献比例（fraction）

**定义**：某辐射源在总功率密度中的占比。

**范围**：0 ~ 1（可能因取 Top-K 而小于 1）

**计算**：
```
fraction_i = S_i / Σ S_all_sources
```

---

## 使用示例

### 1. 单频段查询

```python
import rasterio
from pathlib import Path

output_dir = Path("outputs/latest")
band = "S"

# 读取栅格
tif_path = output_dir / band / f"{band}_field_strength.tif"
with rasterio.open(tif_path) as src:
    data = src.read(1)
    print(f"S 频段电场强度范围: {data.min():.2f} ~ {data.max():.2f} dBµV/m")
```

### 2. 跨频段对比

```python
import pandas as pd
import numpy as np

# 读取多个频段的 Parquet
bands = ["VHF", "UHF", "S", "X"]
all_results = []

for band in bands:
    parquet_path = f"outputs/latest/{band}/{band}_topk.parquet"
    df = pd.read_parquet(parquet_path)
    df['band'] = band
    all_results.append(df)

combined = pd.concat(all_results)

# 统计各频段的主导源
for band in bands:
    band_df = combined[combined['band'] == band]
    top_sources = band_df[band_df['rank'] == 0]['source_id'].value_counts()
    print(f"{band} 频段主导源: {top_sources.head(3)}")
```

### 3. 热点区域识别

```python
import rasterio
import numpy as np
from pathlib import Path

# 识别电场强度超过阈值的区域
band = "S"
tif_path = Path(f"outputs/latest/{band}/{band}_field_strength.tif")

with rasterio.open(tif_path) as src:
    data = src.read(1)
    threshold = 80  # dBµV/m
    
    # 找出热点
    hotspots = np.where(data > threshold)
    
    # 转换热点坐标为经纬度
    rows, cols = hotspots
    lats, lons = np.zeros(len(rows)), np.zeros(len(rows))
    for i, (row, col) in enumerate(zip(rows, cols)):
        lon, lat = rasterio.transform.xy(src.transform, row, col)
        lats[i], lons[i] = lat, lon
    
    print(f"在 {band} 频段发现 {len(lats)} 个热点区域")
    print(f"热点最大强度: {data[rows, cols].max():.2f} dBµV/m")
```

### 4. 数据可视化

```python
import rasterio
import matplotlib.pyplot as plt
from matplotlib.colors import LinearSegmentedColormap

# 读取并可视化栅格
tif_path = "outputs/latest/S/S_field_strength.tif"
with rasterio.open(tif_path) as src:
    data = src.read(1)
    bounds = src.bounds
    
    # 创建可视化
    fig, ax = plt.subplots(figsize=(10, 8))
    
    im = ax.imshow(
        data,
        extent=[bounds.left, bounds.right, bounds.bottom, bounds.top],
        cmap='viridis',
        interpolation='bilinear'
    )
    
    plt.colorbar(im, label='电场强度 (dBµV/m)')
    plt.xlabel('经度')
    plt.ylabel('纬度')
    plt.title('S 频段电场强度分布')
    plt.tight_layout()
    plt.savefig('S_band_visualization.png', dpi=300)
```

---

## 注意事项

### 1. 数据有效性
- **NaN 值**：代表低于阈值或无信号区域，分析时需过滤
- **区域边界**：仅输出在 `region.polygon` 内的栅格数据
- **单一高度**：当前版本仅支持单一高度切片（`grid.alt_m`）

### 2. 性能建议
- **栅格尺寸**：`resolution_deg=0.01` 对应约 1 km 分辨率，适合区域级分析
- **Parquet 压缩**：Top-K 数据已压缩，适合批量读取和并行分析
- **内存占用**：大区域（如 200×200 km）栅格可能达数百 MB

### 3. 计算假设
- **不考虑遮蔽**：无地形/建筑遮挡，视为自由空间传播
- **峰值聚合**：天线扫描取峰值（不平均）
- **功率相加**：多源采用线性功率求和

---

## 与外部系统集成

### REST API 输出查询

```python
import requests

# 查询某点场强
response = requests.post(
    "http://localhost:8000/query",
    json={
        "lat": 33.80,
        "lon": 118.10,
        "alt_m": 100,
        "band": "S"
    }
)

result = response.json()
print(f"场强: {result['field_strength_dbuv_per_m']:.2f} dBµV/m")
print(f"Top-3 贡献: {result['top3_sources']}")
```

### 数据库存储

```python
import pandas as pd
from sqlalchemy import create_engine

# 读取并入库
df = pd.read_parquet("outputs/latest/S/S_topk.parquet")
engine = create_engine("postgresql://user:pass@localhost/emdb")

df.to_sql(
    "em_field_topk",
    engine,
    if_exists="append",
    index=False
)
```

---

## 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1 | 2024 | 初始规范：GeoTIFF 栅格 + Parquet 诊断 |
| - | - | 支持 Top-K 源追踪、阈值裁剪、多频段输出 |

---

—— 完 ——

