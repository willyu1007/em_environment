# EM环境服务程序运行和算法调用

## 目录
1. [环境安装](#环境安装)
2. [命令行接口使用](#命令行接口使用)
3. [REST API调用](#rest-api调用)
4. [算法调用细节](#算法调用细节)
5. [输入参数详解](#输入参数详解)
6. [输出结果说明](#输出结果说明)
7. [实际使用示例](#实际使用示例)
8. [故障排除](#故障排除)

## 环境安装

### 系统要求
- Python 3.10 或更高版本
- Windows/Linux/macOS 操作系统

### 安装步骤

1. **创建虚拟环境**
```bash
python -m venv .venv
```

2. **激活虚拟环境**
```bash
# Windows
.venv\Scripts\activate

# Linux/macOS
source .venv/bin/activate
```

3. **安装依赖包**
```bash
pip install -r requirements.txt
```

4. **开发环境安装（可选）**
```bash
pip install -e .[dev]
```

### 依赖包说明
- `numpy>=1.24`: 数值计算核心
- `pydantic>=1.10,<2.0`: 数据验证和序列化
- `fastapi>=0.110`: Web API框架
- `uvicorn[standard]>=0.24`: ASGI服务器
- `rasterio>=1.3`: 地理栅格数据处理
- `pyarrow>=16.1`: Parquet文件格式支持

## 命令行接口使用

### 基本语法
```bash
python -m emenv.app.cli <输入文件> [选项]
```

### 参数说明
- `<输入文件>`: JSON格式的请求配置文件路径
- `--band <频段名>`: 指定要统计的频段（默认为第一个频段）
- `--output-dir <输出目录>`: 指定输出文件目录

### 使用示例

1. **基本计算**
```bash
python -m emenv.app.cli examples/request_basic_free_space.json
```

2. **指定输出目录**
```bash
python -m emenv.app.cli examples/request_multi_band_dense.json --output-dir outputs/demo
```

3. **指定特定频段**
```bash
python -m emenv.app.cli examples/request_multi_band_dense.json --band C --output-dir outputs/c_band
```

### 输出说明
命令行执行后会显示：
- 计算的频段列表
- 指定频段的中心频率
- 场强统计信息（最小值、最大值、平均值）
- 输出文件路径（如果指定了输出目录）

## REST API调用

### 启动服务
```bash
uvicorn emenv.app.rest:app --reload
```

服务启动后可通过 `http://127.0.0.1:8000` 访问。

### API端点

#### 1. 健康检查
```bash
GET /health
```

#### 2. 计算请求
```bash
POST /compute
Content-Type: application/json
```

**请求体**: JSON格式的ComputeRequest对象

**响应**:
```json
{
  "message": "accepted",
  "bands": ["S", "C", "X"]
}
```

#### 3. 查询特定点
```bash
POST /query
Content-Type: application/json
```

**请求体**:
```json
{
  "lat": 33.90,
  "lon": 118.15,
  "band": "S"
}
```

**响应**:
```json
{
  "band": "S",
  "field_strength_dbuv_per_m": 85.2,
  "power_density_W_m2": 1.2e-8,
  "top_contributors": [0, 1, 2]
}
```

### API调用示例

1. **使用curl进行计算**
```bash
curl -X POST http://127.0.0.1:8000/compute \
  -H "Content-Type: application/json" \
  --data-binary "@examples/request_basic_free_space.json"
```

2. **查询特定位置**
```bash
curl -X POST http://127.0.0.1:8000/query \
  -H "Content-Type: application/json" \
  -d '{"lat": 33.90, "lon": 118.15, "band": "S"}'
```

## 算法调用细节

### 核心计算引擎

#### ComputeEngine类
主计算引擎，负责协调整个计算流程：

```python
from emenv.engine import ComputeEngine, ENGINE_CONFIG

# 创建计算引擎实例
engine = ComputeEngine(config=ENGINE_CONFIG)

# 执行计算
result = engine.compute(request)
```

#### 计算流程
1. **输入验证**: 验证请求参数的有效性
2. **网格生成**: 根据区域和分辨率创建计算网格
3. **源过滤**: 基于影响缓冲区过滤相关辐射源
4. **几何计算**: 计算源到网格点的距离、方位角、仰角
5. **传播计算**: 计算传播损耗和大气衰减
6. **天线增益**: 计算天线方向图增益
7. **功率密度**: 计算各源在网格点的功率密度
8. **源叠加**: 计算总功率密度和Top-K贡献源
9. **场强转换**: 将功率密度转换为电场强度

#### 关键算法模块

**1. 传播模型** (`emenv.propagation`)
- 自由空间传播
- 大气衰减（气体、雨、雾）
- 地球曲率修正

**2. 天线模型** (`emenv.antenna`)
- 简化方向性天线
- 旁瓣模板（MIL-STD-20, RCS-13等）
- 扫描模式支持

**3. 源组合** (`emenv.combine`)
- 功率叠加
- Top-K贡献源识别
- 场强转换

**4. 地理计算** (`emenv.geo`)
- 大圆距离计算
- 方位角和仰角计算
- 坐标转换

### 配置参数

#### 引擎配置 (`emenv.config`)
```python
@dataclass
class EngineConfig:
    top_k: int = 3  # Top-K贡献源数量
    threshold_dbuv_per_m: float = 20.0  # 场强阈值
```

## 输入参数详解

### 请求结构 (ComputeRequest)

#### 1. 区域定义 (region)
```json
{
  "region": {
    "crs": "WGS84",
    "polygon": [
      {"lat": 34.00, "lon": 118.00},
      {"lat": 34.00, "lon": 118.30},
      {"lat": 33.80, "lon": 118.30},
      {"lat": 33.80, "lon": 118.00}
    ]
  }
}
```

#### 2. 网格设置 (grid)
```json
{
  "grid": {
    "resolution_deg": 0.02,  // 网格分辨率（度）
    "alt_m": 50              // 接收高度（米）
  }
}
```

#### 3. 环境参数 (environment)
```json
{
  "environment": {
    "propagation": {
      "model": "free_space"  // 传播模型
    },
    "atmosphere": {
      "gas_loss": "auto",           // 气体损耗
      "rain_rate_mmph": 0,          // 降雨率（mm/h）
      "fog_lwc_gm3": 0             // 雾液态水含量（g/m³）
    },
    "earth": {
      "k_factor": 1.3333333333     // 地球等效半径因子
    }
  }
}
```

#### 4. 频段定义 (bands)
```json
{
  "bands": [
    {
      "name": "S",
      "f_min_MHz": 2000,
      "f_max_MHz": 4000,
      "ref_bw_kHz": 1000
    }
  ]
}
```

#### 5. 辐射源定义 (sources)
```json
{
  "sources": [
    {
      "id": "radar_free",
      "type": "radar",
      "position": {
        "lat": 33.90,
        "lon": 118.15,
        "alt_m": 35
      },
      "emission": {
        "eirp_dBm": 92,              // 等效全向辐射功率
        "center_freq_MHz": 3200,     // 中心频率
        "bandwidth_MHz": 8,          // 带宽
        "polarization": "H",         // 极化方式
        "duty_cycle": 0.2           // 占空比
      },
      "antenna": {
        "pattern": {
          "type": "simplified_directional",
          "hpbw_deg": 3.5,           // 水平半功率波束宽度
          "vpbw_deg": 3.5,           // 垂直半功率波束宽度
          "sidelobe_template": "MIL-STD-20"
        },
        "pointing": {
          "az_deg": 30,              // 方位角
          "el_deg": 0                // 仰角
        },
        "scan": {
          "mode": "circular",        // 扫描模式
          "rpm": 15,                 // 转速（转/分）
          "sector_deg": 360          // 扫描扇区
        }
      }
    }
  ]
}
```

### 参数说明

#### 传播模型类型
- `free_space`: 自由空间传播
- `two_ray`: 双射线模型
- `atmospheric`: 大气衰减模型

#### 天线类型
- `simplified_directional`: 简化方向性天线
- `omni`: 全向天线

#### 扫描模式
- `none`: 无扫描
- `circular`: 圆形扫描
- `sector`: 扇形扫描

#### 极化方式
- `H`: 水平极化
- `V`: 垂直极化
- `RHCP`: 右旋圆极化
- `LHCP`: 左旋圆极化

## 输出结果说明

### 1. 命令行输出
```
Computed bands: S, C, X
Band: S (center 3000.00 MHz)
Field strength stats (dBμV/m): min=45.23, max=98.76, mean=72.45
Outputs written to D:\outputs\demo
```

### 2. 文件输出

#### GeoTIFF文件
- 文件名: `{频段名}_field_strength.tif`
- 内容: 电场强度栅格数据
- 格式: 地理坐标系统，WGS84投影

#### Parquet文件
- 文件名: `{频段名}_topk.parquet`
- 内容: Top-K贡献源信息
- 字段:
  - `lat`, `lon`: 网格点坐标
  - `topk_indices`: Top-K源索引
  - `topk_power_W_m2`: Top-K源功率密度
  - `topk_fraction`: Top-K源贡献比例

### 3. API响应

#### 计算响应
```json
{
  "message": "accepted",
  "bands": ["S", "C", "X"]
}
```

#### 查询响应
```json
{
  "band": "S",
  "field_strength_dbuv_per_m": 85.2,
  "power_density_W_m2": 1.2e-8,
  "top_contributors": [0, 1, 2]
}
```

## 实际使用示例

### 示例1: 单源自由空间计算

**输入文件**: `examples/request_basic_free_space.json`

**执行命令**:
```bash
python -m emenv.app.cli examples/request_basic_free_space.json --output-dir outputs/free_space
```

**特点**:
- 单个雷达源
- 自由空间传播
- S频段（2-4 GHz）
- 圆形扫描模式

### 示例2: 多频段密集场景

**输入文件**: `examples/request_multi_band_dense.json`

**执行命令**:
```bash
python -m emenv.app.cli examples/request_multi_band_dense.json --output-dir outputs/multi_band
```

**特点**:
- 多个辐射源（AWACS、中继站、干扰机）
- 多频段计算（UHF、L、C、X）
- 不同天线类型和扫描模式
- 大气衰减考虑

### 示例3: 通信和干扰场景

**输入文件**: `examples/request_comm_and_jammer.json`

**特点**:
- 通信基站和干扰机混合场景
- 不同极化方式
- 扇形扫描模式

### 示例4: 大范围多源场景

**输入文件**: `examples/request_wide_area.json`

**特点**:
- 大范围区域计算
- 多个不同类型的辐射源
- 复杂传播环境

### 示例5: 双射线传播模型

**输入文件**: `examples/request_two_ray.json`

**特点**:
- 双射线传播模型
- 考虑地面反射
- 大气衰减

## 故障排除

### 常见问题

#### 1. 依赖安装问题
**问题**: `pip install` 失败
**解决方案**:
```bash
# 升级pip
python -m pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

#### 2. 内存不足
**问题**: 大范围计算时内存不足
**解决方案**:
- 减小网格分辨率
- 缩小计算区域
- 减少辐射源数量
- 增加系统内存

#### 3. 计算时间过长
**问题**: 计算时间超过预期
**解决方案**:
- 增大网格分辨率（减少网格点数量）
- 减小影响缓冲区
- 使用更快的传播模型

#### 4. 输出文件无法打开
**问题**: GeoTIFF文件损坏或无法读取
**解决方案**:
- 检查输出目录权限
- 确保有足够的磁盘空间
- 重新安装rasterio包

#### 5. API服务启动失败
**问题**: `uvicorn` 启动失败
**解决方案**:
```bash
# 检查端口占用
netstat -an | grep 8000

# 使用不同端口
uvicorn emenv.app.rest:app --port 8001
```

### 调试技巧

#### 1. 启用详细日志
```bash
python -m emenv.app.cli examples/request_basic_free_space.json --output-dir outputs/debug -v
```

#### 2. 检查输入文件格式
```python
import json
with open('examples/request_basic_free_space.json', 'r') as f:
    data = json.load(f)
    print(json.dumps(data, indent=2))
```

#### 3. 验证计算结果
```python
import numpy as np
import rasterio

# 读取GeoTIFF文件
with rasterio.open('outputs/S/S_field_strength.tif') as src:
    data = src.read(1)
    print(f"数据范围: {np.nanmin(data):.2f} - {np.nanmax(data):.2f}")
    print(f"有效像素数: {np.sum(~np.isnan(data))}")
```

### 性能优化建议

#### 1. 计算参数优化
- 合理设置网格分辨率（0.01-0.05度）
- 适当设置影响缓冲区（100-300km）
- 选择合适的传播模型

#### 2. 系统资源优化
- 使用SSD存储提高I/O性能
- 增加系统内存
- 使用多核CPU

#### 3. 代码优化
- 批量处理多个请求
- 使用缓存机制
- 并行计算多个频段

---

## 联系支持

如有问题或建议，请联系EM环境服务开发团队。
